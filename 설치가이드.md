# 프로그램 설치 가이드입니다.  

---

## 사용법
- 로컬 PC(Windows 또는 Linux)에서 **백엔드와 프론트엔드 실행**
- 데이터베이스 **생성/연결 및 마이그레이션 적용**
- 브라우저에서 **네트워크 다이어그램 UI 확인**
- **Ping 권한** 설정 및 기본 성능 튜닝
- (선택) **프로덕션 빌드** 후 서버(Nginx/IIS)로 배포

---

## 1) 준비물 (필수 설치)
아래 4가지는 꼭 설치되어야 합니다.

1. **.NET 6.0 SDK**
   - 콘솔에서 버전 확인:
     ```bash
     dotnet --version
     ```
     숫자가 `6.x.x` 로 나오면 OK.

2. **Node.js 18.x (LTS 권장)**
   - 콘솔에서 버전 확인:
     ```bash
     node --version
     npm --version
     ```
     `v18.x` / `8.x` 이상이면 OK.

3. **Git**
   - 다운로드 후 설치. (또는 ZIP으로 프로젝트를 받아도 됩니다)

4. **데이터베이스**
   - 기본 권장: **SQL Server** (Express 도 가능)
   - 대체: **SQLite** (설치 간단 / 파일형 DB)

> 처음이면 **SQL Server Express** + **LocalDB** 조합을 추천합니다.  
> Linux라면 **SQLite**가 가장 쉽습니다.

---

## 2) 프로젝트 받기

### 방법 A: Git으로 받기
```bash
git clone <당신의-레포-주소>
cd TraceNet
```

### 방법 B: ZIP으로 받기
- 코드를 ZIP으로 받아서 원하는 폴더에 압축 해제
- 폴더 이름 예: `TraceNet`

> 이 문서의 경로 표기는 `TraceNet/` 폴더 기준으로 설명합니다.

---

## 3) 데이터베이스 선택 & 연결 문자열 설정

TraceNet은 **SQL Server** 또는 **SQLite** 둘 다 사용할 수 있습니다.  
아래에서 **하나를 선택**하세요.

### (A) SQL Server 사용
1) 서버/인증 정보를 확인합니다. (예: `Server=localhost,1433; User Id=sa; Password=***;`)
2) `TraceNet/server/appsettings.json` (또는 `appsettings.Development.json`)을 열고 다음과 같이 수정합니다:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=TraceNet;Trusted_Connection=True;MultipleActiveResultSets=true;"
  },
  "Logging": { "LogLevel": { "Default": "Information" } }
}
```

- **Windows (로컬)**: `Trusted_Connection=True`로도 연결 가능 (Windows 인증)
- **SQL Server Express(LocalDB)** 예시:
  ```json
  "DefaultConnection": "Server=(localdb)\\MSSQLLocalDB;Database=TraceNet;Trusted_Connection=True;"
  ```
- **SQL 계정 사용 예시**:
  ```json
  "DefaultConnection": "Server=localhost,1433;Database=TraceNet;User Id=sa;Password=YourStrong!Passw0rd;"
  ```

### (B) SQLite 사용 (가장 간단)
1) `appsettings.json`에서 SQLite 연결 문자열로 교체합니다.
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=tracenet.db"
  }
}
```
2) 별도 설치 없이 파일형 DB(`tracenet.db`)가 같은 폴더에 생성됩니다.

> **중요**: 운영 환경에서는 `appsettings.Production.json`에 실제 값을 넣고 사용하세요.

---

## 4) 백엔드(서버) 준비 — 마이그레이션 & 실행

### 4-1) EF Core CLI 설치 (처음 한 번만)
```bash
dotnet tool install --global dotnet-ef
# (이미 설치되어 있다면) dotnet tool update --global dotnet-ef
```

### 4-2) 패키지 복원 & DB 마이그레이션
```bash
cd TraceNet/server
dotnet restore
dotnet ef database update
```

- 성공하면 DB가 생성되고 필요한 테이블이 만들어집니다.

### 4-3) 백엔드 실행
```bash
dotnet run
```
- 콘솔 로그에서 다음과 같은 줄을 확인하세요:
  ```
  Now listening on: http://localhost:5285
  ```
- 숫자는 환경에 따라 다를 수 있습니다. **포트 번호를 기억**해 두세요. (5285는 유동적)

### 4-4) API 확인 (선택)
- 브라우저에서 접속: `http://localhost:5285/api/device`
  - JSON 배열이 나오면 OK
- 또는 콘솔에서:
  ```bash
  curl http://localhost:5285/api/device
  ```

> **라우트 주의**: 프로젝트에 따라 `api/device` 또는 `api/devices` 중 하나를 사용합니다.  
> 기본 README/코드에서 **단수형(`/api/device`)** 를 사용하므로 이 가이드는 단수형 기준으로 설명합니다.

---

## 5) 프론트엔드(클라이언트) 준비 — 개발 모드 실행

### 5-1) 의존성 설치
```bash
cd TraceNet/client
npm install
```

### 5-2) API 주소 설정 (.env.local)
**개발 모드**에서는 프론트(5173)와 백엔드(예: 5285)가 **다른 포트**로 뜹니다.  
`.env.local` 파일을 만들어 백엔드 API 주소를 지정합니다.

```bash
# Windows (PowerShell)
echo VITE_API_BASE=http://localhost:5285 > .env.local

# Linux/macOS (bash/zsh)
echo "VITE_API_BASE=http://localhost:5285" > .env.local
```

### 5-3) 개발 서버 실행
```bash
npm run dev
```
- 브라우저에서 `http://localhost:5173` 접속
- 화면이 보이고, 상단의 **새로고침**, **Ping**, **검색** 등이 동작하면 성공입니다.

> **CORS 이슈**가 있으면, 프론트 `.env.local`의 `VITE_API_BASE`가 정확한지 확인하세요.

---

## 6) 초기 데이터 넣기 (선택사항)

처음 실행하면 데이터가 비어 있을 수 있습니다. 아래 2가지 방법 중 하나를 사용하세요.

### 방법 A) UI의 **JSON 업로드** 버튼 사용 (가장 쉬움)
- 상단 ControlBar에 **📂 JSON 업로드** 버튼이 있습니다.
- 예시 JSON 파일(아래)을 만들어 업로드하세요.

```json
{
  "devices": [
    { "name": "SERVER-01", "type": "server", "ipAddress": "192.168.1.254", "rackId": 1, "enablePing": true },
    { "name": "SW-01",     "type": "switch", "ipAddress": "192.168.1.1",   "rackId": 1, "portCount": 25  },
    { "name": "PC-01",     "type": "pc",     "ipAddress": "192.168.1.101" }
  ],
  "cables": [
    { "type": "ethernet", "description": "SW-01 to SERVER-01", "fromDevice": "SW-01", "fromPort": "21", "toDevice": "SERVER-01", "toPort": "1" },
    { "type": "ethernet", "description": "SW-01 to PC-01",     "fromDevice": "SW-01", "fromPort": "1",  "toDevice": "PC-01",     "toPort": "1" }
  ]
}
```

### 방법 B) API로 직접 업로드
- 프로젝트에 따라 Import API가 **파일 업로드(`/api/import`)** 또는 **분리 엔드포인트**일 수 있습니다.
- 분리형 예시:
  ```bash
  # devices 등록
  curl -X POST http://localhost:5285/api/import/devices \
       -H "Content-Type: application/json" \
       -d @devices.json

  # cables 등록
  curl -X POST http://localhost:5285/api/import/cables \
       -H "Content-Type: application/json" \
       -d @cables.json
  ```

> 업로드 후, 상단의 **🔄 새로고침** 버튼을 눌러 화면을 갱신하세요.

---

## 7) Ping 기능 활성화 (권한 설정)

### Windows
- **Visual Studio/터미널을 관리자 권한**으로 실행하세요.
- 회사 방화벽/보안정책에 따라 ICMP가 차단되어 있으면 네트워크팀에 문의가 필요할 수 있습니다.

### Linux
- dotnet에 RAW 소켓 권한 부여 (한 번만)
  ```bash
  sudo setcap cap_net_raw+ep /usr/bin/dotnet
  ```
- 이후 `dotnet run`을 일반 사용자로 실행해도 Ping 가능.

> Ping이 되지 않으면: 장비의 IP가 올바른지, `EnablePing`이 true인지 확인하세요.

---

## 8) 프로덕션 배포 (요약)

### 8-1) 백엔드 빌드
```bash
cd TraceNet/server
dotnet publish -c Release -o ./publish
```

### 8-2) 프론트엔드 빌드
```bash
cd TraceNet/client
echo "VITE_API_BASE=/api" > .env.production
npm ci
npm run build
```

### 8-3) 리버스 프록시 구성
- **Nginx** 예시 (Linux):
  ```nginx
  server {
      listen 80;
      server_name tracenet.local;

      # 프론트엔드 정적 파일
      root /var/www/tracenet/client/dist;
      index index.html;
      location / {
          try_files $uri /index.html;
      }

      # 백엔드 API 프록시
      location /api/ {
          proxy_pass http://127.0.0.1:5285/;
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-For $remote_addr;
      }
  }
  ```

- **IIS** 예시 (Windows):
  - 사이트 루트: `client/dist`  
  - URL Rewrite로 SPA 라우팅 처리  
  - `/api/*` → 백엔드 `http://localhost:5285` 로 프록시

> 운영 환경에서는 `server/appsettings.Production.json`에 연결 문자열을 넣고 `ASPNETCORE_ENVIRONMENT=Production` 으로 실행하세요.

---

## 9) 문제 해결 (Troubleshooting)

### A. 백엔드가 실행되지 않음
```bash
dotnet --version          # 6.x 확인
dotnet restore            # 패키지 복원
dotnet ef database update # 마이그레이션 적용
```
- 포트 충돌 시 `Properties/launchSettings.json`의 URL을 변경하세요.

### B. 프론트에서 API가 404/CORS
- `client/.env.local`의 `VITE_API_BASE`가 **정확한 백엔드 주소**인지 확인하세요.
- 백엔드가 실제로 떠 있고(`dotnet run`), 로그의 포트 번호가 맞는지 확인.
- 프록시(Nginx/IIS) 설정이 `/api` 경로를 **정확히 백엔드로 전달**하는지 확인.

### C. Ping이 전혀 동작하지 않음
- Windows: **관리자 권한**으로 실행
- Linux: `setcap` 권한 부여
- 장비 `IPAddress`가 유효한지, `EnablePing=true`인지 확인

### D. 장비 삭제/초기화가 필요
- 테스트 초기화용 API:
  ```bash
  # 프로젝트 라우트 기준 (단수형 예)
  curl -X DELETE http://localhost:5285/api/device/all
  ```

### E. JSON 업로드 실패
- 파일 인코딩은 `UTF-8` 권장
- 필드명 확인: `devices[]` 안의 `name, type, ipAddress, rackId, portCount, enablePing` 등
- 스위치만 `rackId` 허용, PC/Server는 RackId 무시됨

---

## 10) 질문(FAQ)

**Q1. DB를 바꿔도 되나요? (SQL Server ↔ SQLite)**  
A. 네. `appsettings.json`의 연결 문자열만 교체하고 `dotnet ef database update`를 다시 실행하세요.

**Q2. 포트 번호를 고정하고 싶어요.**  
A. `server/Properties/launchSettings.json`의 `applicationUrl`을 수정하세요. 예: `"http://localhost:5285"`

**Q3. 서버와 프론트엔드를 같은 도메인에서 서빙하고 싶어요.**  
A. Nginx/IIS 리버스 프록시로 `/api`만 백엔드로 보내도록 설정하세요. 프런트는 `client/dist` 정적 파일을 제공합니다.

**Q4. Import JSON의 정확한 스키마는?**  
A. 기본 예시는 본문에 있습니다. 더 자세한 필드/관계는 `docs/api-spec.md` 또는 서버 컨트롤러 주석을 참고하세요.

---


## 부록 A) 폴더 구조 다시 보기
```
TraceNet/
├── server/                    # ASP.NET Core 백엔드
│   ├── Controllers/           # REST API 엔드포인트
│   ├── Services/              # 비즈니스 로직
│   ├── Models/                # EF Core 엔터티
│   ├── DTOs/                  # API DTO
│   └── Data/                  # DbContext, Migrations 등
└── client/                    # React 프론트엔드
    └── src/
        ├── components/        # UI 컴포넌트
        ├── api/               # API 레이어
        ├── utils/             # 유틸리티
        └── types/             # 타입 정의
```

---

## 부록 B) 환경 변수 예시
- 개발(Dev):
  ```bash
  VITE_API_BASE=http://localhost:5285
  ```
- 프로덕션(Prod):
  ```bash
  VITE_API_BASE=/api
  ```

---

