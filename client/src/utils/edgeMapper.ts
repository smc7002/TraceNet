// ğŸ“ src/utils/edgeMapper.ts

import type { Edge } from "react-flow-renderer";
import type { CableDto } from "../types/cable";
import type { CableEdge } from "../types/trace";

/**
 * Edge Mapper Utilities
 * 
 * ë„¤íŠ¸ì›Œí¬ ì¼€ì´ë¸” ë°ì´í„°ë¥¼ React Flowì˜ Edge ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆì…ë‹ˆë‹¤.
 * ë‹¤ì–‘í•œ ì¼€ì´ë¸” íƒ€ì…(ì¼ë°˜ ì¼€ì´ë¸”, ì¶”ì  ì¼€ì´ë¸”)ì„ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œí˜„í•˜ê³ ,
 * ë ˆì´ì•„ì›ƒ ëª¨ë“œì— ë”°ë¥¸ ì ì ˆí•œ ìŠ¤íƒ€ì¼ë§ì„ ì œê³µí•©ë‹ˆë‹¤.
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * - ì¼ë°˜ ì¼€ì´ë¸” â†’ ê¸°ë³¸ ì—°ê²°ì„  ë³€í™˜
 * - ì¶”ì  ì¼€ì´ë¸” â†’ ê°•ì¡°ëœ ì• ë‹ˆë©”ì´ì…˜ ì—°ê²°ì„  ë³€í™˜
 * - ì¤‘ë³µ ì¼€ì´ë¸” í•„í„°ë§ (ì¶”ì  ì‹œ ê¸°ë³¸ ì¼€ì´ë¸” ìˆ¨ê¹€)
 * - ë ˆì´ì•„ì›ƒë³„ ì°¨ë³„í™”ëœ ìŠ¤íƒ€ì¼ë§ (ê³„ì¸µí˜• vs ë°©ì‚¬í˜•)
 * 
 * @module EdgeMapper
 * @version 1.0.0
 */

// ================================
// ì¼ë°˜ ì¼€ì´ë¸” ë§¤í•‘ í•¨ìˆ˜
// ================================

/**
 * ê¸°ë³¸ ì¼€ì´ë¸” ë°ì´í„°ë¥¼ React Flow Edge ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * 
 * ì´ í•¨ìˆ˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ì¼€ì´ë¸” ì •ë³´ë¥¼ ì‹œê°ì  ë‹¤ì´ì–´ê·¸ë¨ ìš”ì†Œë¡œ ë³€í™˜í•˜ì—¬
 * ë„¤íŠ¸ì›Œí¬ì˜ ë¬¼ë¦¬ì  ì—°ê²° ê´€ê³„ë¥¼ í‘œí˜„í•©ë‹ˆë‹¤. ë ˆì´ì•„ì›ƒ ëª¨ë“œì— ë”°ë¼
 * ë‹¤ë¥¸ ë Œë”ë§ ë°©ì‹ê³¼ ìŠ¤íƒ€ì¼ì„ ì ìš©í•©ë‹ˆë‹¤.
 * 
 * ë³€í™˜ ê³¼ì •:
 * 1. ì¼€ì´ë¸” ID ê¸°ë°˜ ê³ ìœ  ì‹ë³„ì ìƒì„±
 * 2. ì¥ë¹„ IDë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë…¸ë“œ ì—°ê²°
 * 3. ë ˆì´ì•„ì›ƒ ëª¨ë“œë³„ ìŠ¤íƒ€ì¼ ë° í•¸ë“¤ ì„¤ì •
 * 4. ì¼€ì´ë¸” ì„¤ëª…ì„ ë¼ë²¨ë¡œ ì¶”ê°€
 * 
 * @param cables - ë³€í™˜í•  ì¼€ì´ë¸” DTO ë°°ì—´
 * @param isRadial - ë°©ì‚¬í˜• ë ˆì´ì•„ì›ƒ ì‚¬ìš© ì—¬ë¶€
 * @returns React Flow Edge ê°ì²´ ë°°ì—´
 * 
 * @example
 * ```typescript
 * const cables = [
 *   { cableId: 1, fromDeviceId: 10, toDeviceId: 20, description: "ë°±ë³¸ ì—°ê²°" }
 * ];
 * const edges = mapCablesToEdges(cables, false);
 * // â†’ [{ id: "cable-1", source: "10", target: "20", ... }]
 * ```
 * 
 * @remarks
 * ë ˆì´ì•„ì›ƒë³„ ì°¨ì´ì :
 * - **ê³„ì¸µí˜• (Hierarchical)**: ê²€ì€ìƒ‰ ì‹¤ì„ , sourceHandle/targetHandle í¬í•¨
 * - **ë°©ì‚¬í˜• (Radial)**: ì»¤ìŠ¤í…€ ì—£ì§€ íƒ€ì… ì‚¬ìš©, í•¸ë“¤ ì •ë³´ ì œì™¸
 */
export function mapCablesToEdges(
  cables: CableDto[],
  isRadial: boolean
): Edge[] {
  // ì…ë ¥ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
  if (!Array.isArray(cables)) return [];

  return cables.map((cable) => {
    /**
     * ê¸°ë³¸ Edge ê°ì²´ êµ¬ì„±
     * 
     * ëª¨ë“  ë ˆì´ì•„ì›ƒì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ê¸°ë³¸ ì†ì„±ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
     * ê° ì¼€ì´ë¸”ì˜ ê³ ìœ  íŠ¹ì„±ì„ ë°˜ì˜í•˜ì—¬ ì‹œê°ì  êµ¬ë¶„ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
     */
    const baseEdge = {
      /** ì¼€ì´ë¸” ê³ ìœ  ì‹ë³„ì (prefixë¡œ íƒ€ì… êµ¬ë¶„) */
      id: `cable-${cable.cableId}`,
      
      /** ì‹œì‘ ë…¸ë“œ ID (ì¥ë¹„ IDë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜) */
      source: cable.fromDeviceId.toString(),
      
      /** ë ë…¸ë“œ ID (ì¥ë¹„ IDë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜) */
      target: cable.toDeviceId.toString(),
      
      /** 
       * Edge íƒ€ì… ê²°ì •
       * - ë°©ì‚¬í˜•: ì»¤ìŠ¤í…€ ì—£ì§€ (CustomEdge ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©)
       * - ê³„ì¸µí˜•: ê¸°ë³¸ ì—£ì§€ (React Flow ë‚´ì¥ ìŠ¤íƒ€ì¼)
       */
      type: isRadial ? "custom" : "default",
      
      /**
       * ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ ì „ìš© ìŠ¤íƒ€ì¼
       * ë°©ì‚¬í˜•ì—ì„œëŠ” CustomEdge ì»´í¬ë„ŒíŠ¸ê°€ ìŠ¤íƒ€ì¼ì„ ë‹´ë‹¹
       */
      style: isRadial ? undefined : { 
        stroke: "#000",      // ê²€ì€ìƒ‰ ì—°ê²°ì„ 
        strokeWidth: 2.2     // ì ë‹¹í•œ êµµê¸°ë¡œ ê°€ë…ì„± í™•ë³´
      },
      
      /** ì¼€ì´ë¸” ì„¤ëª…ì„ ë¼ë²¨ë¡œ í‘œì‹œ (ì„ íƒì ) */
      label: cable.description ?? "",
      
      /** ë¼ë²¨ ìŠ¤íƒ€ì¼ë§ */
      labelStyle: {
        fontSize: 10,                    // ì‘ì€ í°íŠ¸ë¡œ ë°©í•´ë°›ì§€ ì•Šê²Œ
        fontWeight: 500,                 // ì¤‘ê°„ êµµê¸°ë¡œ ê°€ë…ì„± í™•ë³´
        transform: "translateY(-8px)",   // ì—°ê²°ì„  ìœ„ìª½ì— ë°°ì¹˜
      },
      
      /** ë©”íƒ€ë°ì´í„° */
      data: {
        /** ì¤‘ë³µ ê²€ì‚¬ìš© í‚¤ (ì¥ë¹„ ID ì¡°í•©) */
        key: `${cable.fromDeviceId}-${cable.toDeviceId}`,
        
        /** ë ˆì´ì•„ì›ƒ ëª¨ë“œ ì •ë³´ (CustomEdgeì—ì„œ ìŠ¤íƒ€ì¼ ê²°ì •ì— ì‚¬ìš©) */
        mode: isRadial ? "radial" : "hierarchical",
      },
    };

    /**
     * ë ˆì´ì•„ì›ƒë³„ í•¸ë“¤ ì •ë³´ ì¶”ê°€
     * 
     * ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒì—ì„œëŠ” ë…¸ë“œì˜ íŠ¹ì • ìœ„ì¹˜(í•¸ë“¤)ì— ì—°ê²°ì„ ì„ ê³ ì •í•˜ì—¬
     * ì •ëˆëœ ì‹œê°ì  í‘œí˜„ì„ ì œê³µí•©ë‹ˆë‹¤. ë°©ì‚¬í˜•ì—ì„œëŠ” ììœ ë¡œìš´ ì—°ê²°ì„ ìœ„í•´
     * í•¸ë“¤ ì •ë³´ë¥¼ ì œì™¸í•©ë‹ˆë‹¤.
     */
    return isRadial
      ? baseEdge  // ë°©ì‚¬í˜•: ê¸°ë³¸ ê°ì²´ë§Œ ë°˜í™˜
      : {
          ...baseEdge,
          /** ì¶œë°œì  í•¸ë“¤ (ë…¸ë“œ ìš°ì¸¡ì—ì„œ ì‹œì‘) */
          sourceHandle: "source",
          /** ë„ì°©ì  í•¸ë“¤ (ë…¸ë“œ ì¢Œì¸¡ìœ¼ë¡œ ì—°ê²°) */
          targetHandle: "target",
        };
  });
}

// ================================
// ì¶”ì  ì¼€ì´ë¸” ë§¤í•‘ í•¨ìˆ˜
// ================================

/**
 * ì¶”ì (Trace) ì¼€ì´ë¸”ì„ ê°•ì¡°ëœ Edgeë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * 
 * ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ ì¶”ì ì´ë‚˜ ì¥ì•  ì§„ë‹¨ ì‹œ íŠ¹ì • ì¼€ì´ë¸” ê²½ë¡œë¥¼ ì‹œê°ì ìœ¼ë¡œ
 * ê°•ì¡°í•˜ê¸° ìœ„í•œ íŠ¹ìˆ˜ Edgeë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì¼ë°˜ ì¼€ì´ë¸”ê³¼ êµ¬ë³„ë˜ëŠ”
 * ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ì™€ ìƒ‰ìƒì„ ì ìš©í•©ë‹ˆë‹¤.
 * 
 * íŠ¹ì§•:
 * - ë…¹ìƒ‰ ì ì„ ìœ¼ë¡œ ì¶”ì  ê²½ë¡œì„ì„ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„
 * - ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¡œ ë°ì´í„° íë¦„ ë°©í–¥ í‘œì‹œ
 * - ì‹œê°„ ê¸°ë°˜ ê³ ìœ  IDë¡œ ë™ì¼ ê²½ë¡œì˜ ì¤‘ë³µ ì¶”ì  ì§€ì›
 * - í¬íŠ¸ ë ˆë²¨ì˜ ìƒì„¸ ì—°ê²° ì •ë³´ í¬í•¨
 * 
 * @param cables - ì¶”ì í•  ì¼€ì´ë¸” ì—£ì§€ ë°°ì—´
 * @param timestamp - ì¶”ì  ì‹œì‘ ì‹œê° (ê³ ìœ  ID ìƒì„±ìš©)
 * @returns ê°•ì¡°ëœ React Flow Edge ê°ì²´ ë°°ì—´
 * 
 * @example
 * ```typescript
 * const traceCables = [
 *   { cableId: 1, fromDeviceId: 10, toDeviceId: 20, fromPortId: 1, toPortId: 2 }
 * ];
 * const traceEdges = mapTraceCablesToEdges(traceCables, Date.now());
 * ```
 */
export function mapTraceCablesToEdges(
  cables: CableEdge[],
  timestamp: number
): Edge[] {
  return cables.map((cable, index) => ({
    /**
     * ë³µí•© ê³ ìœ  ì‹ë³„ì ìƒì„±
     * 
     * ë™ì¼í•œ ì¼€ì´ë¸”ì— ëŒ€í•œ ì—¬ëŸ¬ ì¶”ì  ì„¸ì…˜ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´
     * ì¼€ì´ë¸”ID + í¬íŠ¸ID + íƒ€ì„ìŠ¤íƒ¬í”„ + ì¸ë±ìŠ¤ë¥¼ ì¡°í•©í•©ë‹ˆë‹¤.
     */
    id: `trace-${cable.cableId}-${cable.fromPortId}-${cable.toPortId}-${timestamp}-${index}`,
    
    /** ì—°ê²° ë…¸ë“œ ì •ë³´ */
    source: cable.fromDeviceId.toString(),
    target: cable.toDeviceId.toString(),
    
    /** ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ í•¸ë“¤ (ì¶”ì ì€ ì£¼ë¡œ ìƒì„¸ ë¶„ì„ì—ì„œ ì‚¬ìš©) */
    sourceHandle: "source",
    targetHandle: "target",

    /** ì¶”ì  ì „ìš© ì‹œê°ì  ìŠ¤íƒ€ì¼ */
    style: {
      stroke: "#10b981",        // ì—ë©”ë„ë“œ ê·¸ë¦° (ì„±ê³µ/í™œì„± ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ„)
      strokeDasharray: "5 5",   // ì ì„  íŒ¨í„´ìœ¼ë¡œ ì¶”ì ì„ì„ ëª…ì‹œ
      strokeWidth: 2,           // ì¼ë°˜ ì¼€ì´ë¸”ê³¼ ë™ì¼í•œ êµµê¸°
    },
    
    /** ìƒì„¸í•œ ì—°ê²° ì •ë³´ë¥¼ ë¼ë²¨ë¡œ í‘œì‹œ */
    label: `${cable.fromDeviceId} to ${cable.toDeviceId}`,
    
    /** 
     * ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ í™œì„±í™”
     * ì ì„ ì´ íë¥´ëŠ” ë“¯í•œ íš¨ê³¼ë¡œ ë°ì´í„° íë¦„ ë°©í–¥ì„ ì‹œê°í™”
     */
    animated: true,
    
    /** ë©”íƒ€ë°ì´í„° */
    data: {
      /** ì¤‘ë³µ ê²€ì‚¬ìš© í‚¤ */
      key: `${cable.fromDeviceId}-${cable.toDeviceId}`,
      
      /** ì¶”ì  ì¼€ì´ë¸”ì„ì„ í‘œì‹œí•˜ëŠ” í”Œë˜ê·¸ */
      isTrace: true,
    },
  }));
}

// ================================
// ì¤‘ë³µ ì¼€ì´ë¸” í•„í„°ë§ í•¨ìˆ˜
// ================================

/**
 * ì¶”ì  ì¼€ì´ë¸”ê³¼ ì¤‘ë³µë˜ëŠ” ê¸°ë³¸ ì¼€ì´ë¸” Edgeë¥¼ ì œê±°í•©ë‹ˆë‹¤.
 * 
 * ë„¤íŠ¸ì›Œí¬ ì¶”ì  ì‹œ ë™ì¼í•œ ë¬¼ë¦¬ì  ì¼€ì´ë¸”ì´ ì¼ë°˜ ì—°ê²°ê³¼ ì¶”ì  ì—°ê²°ë¡œ
 * ì¤‘ë³µ í‘œì‹œë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤. ì¶”ì  ì¼€ì´ë¸”ì´ ìš°ì„  í‘œì‹œë˜ê³ ,
 * í•´ë‹¹ ê²½ë¡œì˜ ì¼ë°˜ ì¼€ì´ë¸”ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.
 * 
 * ì‘ë™ ì›ë¦¬:
 * 1. ì¶”ì  ì¼€ì´ë¸”ë“¤ì˜ í‚¤(ì¥ë¹„ ID ì¡°í•©) ì§‘í•© ìƒì„±
 * 2. ê¸°ë³¸ ì¼€ì´ë¸” ì¤‘ ë™ì¼í•œ í‚¤ë¥¼ ê°€ì§„ í•­ëª© ì œì™¸
 * 3. ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ê¸°ë³¸ ì¼€ì´ë¸”ë§Œ ë°˜í™˜
 * 
 * @param baseEdges - í•„í„°ë§í•  ê¸°ë³¸ ì¼€ì´ë¸” Edge ë°°ì—´
 * @param traceEdges - ìš°ì„  í‘œì‹œí•  ì¶”ì  ì¼€ì´ë¸” Edge ë°°ì—´
 * @returns ì¤‘ë³µì´ ì œê±°ëœ ê¸°ë³¸ ì¼€ì´ë¸” Edge ë°°ì—´
 * 
 * @example
 * ```typescript
 * const baseEdges = [
 *   { id: "cable-1", data: { key: "10-20" } },
 *   { id: "cable-2", data: { key: "20-30" } }
 * ];
 * const traceEdges = [
 *   { id: "trace-1", data: { key: "10-20" } }
 * ];
 * 
 * const filtered = excludeTraceOverlaps(baseEdges, traceEdges);
 * // â†’ [{ id: "cable-2", data: { key: "20-30" } }]
 * ```
 * 
 * @performance
 * Setì„ ì‚¬ìš©í•œ O(1) ë£©ì—…ìœ¼ë¡œ ëŒ€ìš©ëŸ‰ ë„¤íŠ¸ì›Œí¬ì—ì„œë„ íš¨ìœ¨ì  ì²˜ë¦¬
 */
export function excludeTraceOverlaps(
  baseEdges: Edge[],
  traceEdges: Edge[]
): Edge[] {
  /**
   * ì¶”ì  ì¼€ì´ë¸” í‚¤ ì§‘í•© ìƒì„±
   * 
   * Set ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ê²€ì‚¬ ì‹œ O(1) ì‹œê°„ ë³µì¡ë„ë¡œ
   * ë¹ ë¥¸ í•„í„°ë§ì„ ì œê³µí•©ë‹ˆë‹¤.
   */
  const traceKeySet = new Set(traceEdges.map((edge) => edge.data?.key));
  
  /**
   * ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ê¸°ë³¸ ì¼€ì´ë¸”ë§Œ í•„í„°ë§
   * 
   * ê° ê¸°ë³¸ ì¼€ì´ë¸”ì˜ í‚¤ê°€ ì¶”ì  ì¼€ì´ë¸” ì§‘í•©ì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ”
   * ê²½ìš°ì—ë§Œ ê²°ê³¼ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.
   */
  return baseEdges.filter((edge) => !traceKeySet.has(edge.data?.key));
}